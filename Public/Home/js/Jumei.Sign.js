!function(){window.Jumei=window.Jumei||{},Jumei.Sign={init:function(){if("Account"===RM_CONTROL){Jumei.Sign.initForm(),$(".verityWrap a").click(Jumei.Sign.hashCode);var a="";switch(RM_ACTION){case"login":case"pre_login":Jumei.Sign.ajax_login();break;case"signup":Jumei.Sign.signup()}a=RM_ACTION,_gaq&&_gaq.push&&$("form").submit(function(){"signup"==RM_ACTION?a+="_"+$(this).attr("id"):"pre_login"==RM_ACTION&&(a="login-user-form"==$(this).attr("id")?"login_prelogin":"signup_prelogin"),_gaq.push(["_trackEvent",a,"click"]);try{switch(RM_ACTION){case"login":clickMap("www",!0).accountLogin(1,$("input[name='email']").val());break;case"pre_login":"login-user-form"==$(this).attr("id")?clickMap("www",!0).accountLogin(31,$("input[name='email']").val()):clickMap("www",!0).accountSignup(32,$(this).attr("id"));break;case"signup":clickMap("www",!0).accountSignup(2,$(this).attr("id"))}}catch(b){}})}},inputTypes:function(){document.querySelector||$("input").each(function(){var a="type_"+(this.getAttribute("type")||this.type||"").toLowerCase(),b=a+"_focus";$(this).focus(function(){$(this).addClass(b)}).blur(function(){$(this).removeClass(b)}).addClass(a)})},initForm:function(){Jumei.Sign.inputTypes(),Jumei.Sign.autoComplete(),Jumei.Sign.passwordCheck(),$.fn.signvalidate&&$(".sign form").signvalidate({events:{"*":"startvalidity"}}),$("input").not($("input.type_email, [type='email'], [name='username'], [name='mobile'], [name='mailorhp']").each(function(){Jumei.Sign.setAjaxValidity(this,function(a){this[0].setCustomValidity(a&&!a.status?a.msg:"")})})).change(function(){$(this).trigger("startvalidity")}),(!document.querySelector||document.documentMode<9)&&$(".textbox_ui").focusin(function(){var a=$(this);a.is(".error_ui")||a.find(".focus_text").show()}).focusout(function(){$(this).find(".focus_text").hide()})},setAjaxValidity:function(a,b){function c(c){b.call(a,e[a.val()]),(!c||d)&&(a.trigger("startvalidity"),d=!1),g.hide()}a=$(a).change(function(){d=!0});var d,e={},f=a.closest(".textbox_ui"),g=f.find(".loading"),h=f.find(".invalid");a.bind(a.is(".ui-autocomplete-input")?"autocompletechange":"change",function(){var a=this,b=a.value,d=a.name,f={};c(!0),a.validity.valid&&(h.hide(),e[b]?c():(f[d]=b,g.show(),$.post("/i/account/check_"+d,f,function(a){e[b]=a,c()},"json")))})},passwordCheck:function(){$("form").each(function(){var a=$(this).find(":password");a.eq(0).bind("input",function(){var a=$(this).closest(".textbox_ui"),b=a.find(".safe"),c=this.value,d=c.length>5,e=-1;b.length&&(a.find(".default").toggle(!d),b.toggle(d),d&&(e+=/\d/.test(c)?1:0,e+=/[a-z]/.test(c)?1:0,e+=/[A-Z]/.test(c)?1:0,e+=/\W/.test(c)?1:0),b.find("span").removeClass("rank0 rank1 rank2").eq(e>2?2:e).addClass("rank"+e),this.setCustomValidity(e>0?"":"为了您的账号安全，密码需为6-16位字母和数字的组合")),(!document.querySelector||document.documentMode<9)&&this.validity&&this.validity.valid&&a.find(".focus_text").show()}),a.length>1&&a.change(function(b){var c=a[0].value,d=a[1].value,e=d&&c===d;a[1].setCustomValidity(e||!d?"":"两次密码输入不一致"),(b.target==a[1]&&a[0].validity.valid||e)&&$(a[1]).trigger("startvalidity")})})},autoComplete:function(){var a=["163.com","gmail.com","qq.com","126.com","hotmail.com","sina.com","yahoo.com.cn","yahoo.com","sohu.com","139.com"],b=$("input[type='email'],input[name='mailorhp'],input.type_email");$.fn.autocomplete&&b.autocomplete({source:function(b,c){/^1\d{10}$/.test(b.term)?c():c($.map(a,function(a){return a=b.term.split("@")[0]+"@"+a,new RegExp($.ui.autocomplete.escapeRegex(b.term),"i").test(a)?a:null}))}}),b.each(function(){var a=$(this);"email"===this.type||a.attr("pattern")||b.attr("pattern","[\\w\\.\\-\\+]+@([\\w\\-]+\\.)+\\w+")})},ajax_login:function(){function clearErr(a){setErr(a,"")}function setErr(a,b){a[0].setCustomValidity&&a[0].setCustomValidity(b),(b||a[0].validity.valid)&&a.trigger("startvalidity"),b&&a.focus()}function showMessage(a){if(a.msg)$("#errorMsg").html("操作失败："+a.msg).show();else{a.status<3?setErr(verityBox,"您输入的验证码不正确，请重新输入"):a.status<7&&setErr(passbox,"账号或密码错误，请重新输入。如果已绑定手机号，建议用手机号登录。");var b=!!a.hash_code;verityBox[0].required=b,verityWrap.toggle(b),b&&Jumei.Sign.hashCode()}}function passportLogin(){var redirect=$("#redirect").val(),passportUrl="/i/passport/ajax_login";$.get(passportUrl,{action:"login"},function(data){for(var obj=eval("("+data+")"),i=0;i<obj.length;i++){var requestUrl=obj[i];$.ajax({url:requestUrl,type:"get",dataType:"jsonp",success:function(){location.href=redirect||"/"}})}})}var form=$("#login-user-form").submit(function(a){a.preventDefault(),btnSubmit.disabled=!0;var b={};$.each(form.serializeArray(),function(a,c){b[c.name]=c.value}),$.ajax({type:"POST",url:"/i/account/ajax_login",dataType:"json",data:b,success:function(a){if(a&&a.status)8==a.status?location.href="/i/account/changename"+(c?"?redirect="+encodeURIComponent(c):""):showMessage(a);else{var b=$("#isOpenPassport").val();if("1"==b)passportLogin();else{var c=$("#redirect").val();location.href=c||"/"}}},error:function(){$("#errorMsg").html("操作失败：请刷新重试!").show()},complete:function(){btnSubmit.disabled=!1}})}),btnSubmit=form.find(":submit")[0],textbox=form.find(".user :text,:password").change(function(){textbox.each(function(){clearErr($(this))})}),verityWrap=form.find(".verityWrap"),verityBox=verityWrap.find(":text").change(function(){clearErr(verityBox)}),passbox=form.find(":password")},signup:function(){$(".tabnav a").click(function(){var a=$(this).addClass("curr"),b=a.attr("href");return form=$(b).show(),a.siblings().removeClass("curr"),form.show().siblings().hide(),form.find("[autofocus]").focus(),location.hash=b+"form",!1}).filter("[href='"+location.hash.replace("form","")+"']").click(),$("#phone [name='mobileVerify']")[0].setCustomValidity("没有获取验证码")},hashCode:function(a){function b(a){a>0?c.html("重新发送（"+a+"秒）"):(clearInterval(e),c.data("runing",!1),c.html("免费获取短信校验码"))}var c,d;if(a?(c=$(a.target),d=c.is("img")?c:c.find("img")):d=$(".verityWrap img"),c&&!d.length&&!c.data("runing")){var e,f=60,g={},h=$(c).closest("form").find("[name='mobile']");h[0].checkValidity()?(c.data("runing",!0),e=setInterval(function(){b(--f)},1e3),b(f),g[h.attr("name")]=h.val(),$.getJSON(c.attr("href"),g,function(a){if(a)if("error"===a.status)b(),alert(a.msg),h.focus().select();else{var c=$("#phone [name='mobileVerify']");c[0].setCustomValidity(""),c[0].validity&&c[0].validity.valid&&c.trigger("startvalidity"),alert(a.msg)}})):h.focus()}return d.each(function(){this.src=this.src.replace(/\d+$/,function(){return+new Date})}),!1}}}();